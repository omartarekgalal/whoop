<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>ربط WHOOP واستخراج Access Token</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; background: #f0f0f0; direction: rtl; text-align: center; }
    .box { background: white; padding: 2rem; border-radius: 10px; max-width: 500px; margin: auto; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    input, button, textarea { width: 100%; margin: 10px 0; padding: 10px; font-size: 1em; }
    textarea { height: 120px; }
  </style>
</head>
<body>
  <div class="box">
    <h2>🔗 ربط WHOOP واستخراج Access Token</h2>

    <div id="form">
      <input id="clientId" placeholder="Client ID">
      <input id="clientSecret" placeholder="Client Secret">
      <button onclick="startOAuth()">تسجيل الدخول إلى WHOOP</button>
    </div>

    <div id="result" style="display:none;">
      <h3>🎫 Access Token:</h3>
      <textarea id="tokenBox" readonly></textarea>
    </div>
  </div>

  <script>
    const redirectUri = window.location.origin + window.location.pathname;

function startOAuth() {
  const clientId = document.getElementById("clientId").value.trim();
  const clientSecret = document.getElementById("clientSecret").value.trim();

  localStorage.setItem("client_id", clientId);
  localStorage.setItem("client_secret", clientSecret);

  const state = Math.random().toString(36).substring(2, 12); // 10 حروف عشوائية
  localStorage.setItem("oauth_state", state); // خزنه مؤقتاً لمقارنته لاحقاً

  const authUrl = `https://api.prod.whoop.com/oauth/oauth2/auth?client_id=${clientId}&response_type=code&redirect_uri=${encodeURIComponent(window.location.origin + window.location.pathname)}&scope=read:recovery read:sleep read:cycles read:workout read:profile read:body_measurement&state=${state}`;
  window.location.href = authUrl;
}


    async function exchangeCodeForToken(code) {
      const clientId = localStorage.getItem("client_id");
      const clientSecret = localStorage.getItem("client_secret");

      const body = new URLSearchParams();
      body.append("grant_type", "authorization_code");
      body.append("code", code);
      body.append("client_id", clientId);
      body.append("client_secret", clientSecret);
      body.append("redirect_uri", redirectUri);

      const res = await fetch("https://api.prod.whoop.com/oauth/oauth2/token", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: body
      });

      const json = await res.json();
      document.getElementById("form").style.display = "none";
      document.getElementById("result").style.display = "block";
      document.getElementById("tokenBox").value = json.access_token || JSON.stringify(json, null, 2);
    }

    const params = new URLSearchParams(window.location.search);
    const code = params.get("code");
    if (code) {
      exchangeCodeForToken(code);
    }

    window.onload = () => {
  const params = new URLSearchParams(window.location.search);
  const code = params.get("code");
  const state = params.get("state");
  const storedState = localStorage.getItem("oauth_state");

  if (code && state === storedState) {
    exchangeCodeForToken(code);
  } else if (state && state !== storedState) {
    alert("❌ فشل التحقق من state. يرجى المحاولة من جديد.");
  }
};

  </script>
</body>
</html>
